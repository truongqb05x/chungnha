<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sống Chung - Quản Lý Quỹ Nhóm</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="../static/img/logo.png" type="image/x-icon">
    <!-- css chung -->
     <link rel="stylesheet" href="../static/css/app.css">
    <!-- css riêng -->
     <link rel="stylesheet" href="../static/css/quynhom.css">
</head>
<body>
        <div class="app-container">
             <!-- Header -->
        <header class="header">
            <div class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </div>
            <h1 class="header-title" style="text-align: left;">Quỹ Nhóm</h1>
            <div class="header-actions">
                <div class="header-icon">
                    <a href="/thong-bao" class="btn" style="color: inherit;">
                        <i class="fas fa-bell"></i>
                      </a>
                    <span class="badge">3</span>
                </div>
                <div class="header-icon theme-icon">
                    <i class="fas fa-moon"></i>
                </div>
                <a href="/trang-ca-nhan" class="user-avatar" style="text-decoration: none;">NM</a>
            </div>
        </header>
            <nav class="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-logo">
                        <a href="/trang-ca-nhan">
                            <img src="../static/img/logo.png" alt="Logo">
                          </a>
                    </div>
                    <div>
                        <div class="sidebar-title">Chung Nhà</div>
                        <div class="sidebar-group">Nhóm: Nhà Mình A2</div>
                    </div>
                </div>
            
                <div class="sidebar-nav">
                    <a href="/home" class="nav-item">
                        <div class="nav-icon">
                            <i class="fas fa-home"></i>
                        </div>
                        <div class="nav-text">Trang chủ</div>
                    </a>
                    <a href="/thanh-vien" class="nav-item">
                        <div class="nav-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="nav-text">Thành viên</div>
                    </a>
                    <a href="/noi-quy" class="nav-item">
                        <div class="nav-icon">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="nav-text">Nội quy</div>
                    </a>
                    <a href="/phan-cong-viec" class="nav-item">
                        <div class="nav-icon">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div class="nav-text">Phân công việc</div>
                    </a>
                    <a href="/thuc-don" class="nav-item">
                        <div class="nav-icon">
                            <i class="fas fa-book"></i>
                        </div>
                        <div class="nav-text">Thực đơn</div>
                    </a>
                    <a href="/lich-nau-an" class="nav-item">
                        <div class="nav-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="nav-text">Lịch nấu ăn</div>
                    </a>
                    <a href="/quan-ly-do-dung" class="nav-item">
                        <div class="nav-icon">
                            <i class="fas fa-box-open"></i>
                        </div>
                        <div class="nav-text">Quản lý đồ dùng</div>
                    </a>
                    <a href="/chi-phi" class="nav-item">
                        <div class="nav-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="nav-text">Chi phí</div>
                    </a>
                    <a href="#" class="nav-item active">
                        <div class="nav-icon">
                            <i class="fas fa-piggy-bank"></i>
                        </div>
                        <div class="nav-text">Quỹ nhóm</div>
                    </a>
                    <a href="/thong-ke" class="nav-item">
                        <div class="nav-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <div class="nav-text">Thống kê</div>
                    </a>
                    <a href="/tro-chuyen" class="nav-item">
                        <div class="nav-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div class="nav-text">Trò chuyện</div>
                    </a>
                    <a href="/binh-chon" class="nav-item">
                        <div class="nav-icon">
                            <i class="fas fa-vote-yea"></i>
                        </div>
                        <div class="nav-text">Bình chọn</div>
                    </a>
                </div>
            
                <div class="sidebar-footer">
                    <div class="theme-toggle">
                        <div class="theme-btn active" data-theme="light">
                            <i class="fas fa-sun"></i>
                        </div>
                        <div class="theme-btn" data-theme="dark">
                            <i class="fas fa-moon"></i>
                        </div>
                    </div>
                </div>
            </nav>
    
            <!-- Main content -->
            <main class="main-content">
                <!-- Fund Overview -->
                <div class="card">
                    <div class="section-title">
                        <h2>Tổng Quan Quỹ</h2>
                        <div class="section-actions">
                            <button class="btn btn-secondary" onclick="openAddFundModal()">
                                <i class="fas fa-plus"></i> Thêm quỹ
                            </button>
                        </div>
                    </div>
                    <div class="fund-overview">
                        <div class="fund-card" style="background-color: rgba(66, 133, 244, 0.1);">
                            <div class="icon" style="background-color: rgba(66, 133, 244, 0.2); color: var(--secondary);">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <h3>Số dư quỹ</h3>
                            <p id="fund-balance">0 VNĐ</p>
                            <div class="trend up">
                                <i class="fas fa-arrow-up"></i> 12% so với tháng trước
                            </div>
                        </div>
                        <div class="fund-card" style="background-color: rgba(16, 185, 129, 0.1);">
                            <div class="icon" style="background-color: rgba(16, 185, 129, 0.2); color: var(--success);">
                                <i class="fas fa-users"></i>
                            </div>
                            <h3>Thành viên</h3>
                            <p id="member-count">0</p>
                            <div class="trend up">
                                <i class="fas fa-arrow-up"></i> 2 thành viên mới
                            </div>
                        </div>
                        <div class="fund-card" style="background-color: rgba(255, 109, 40, 0.1);">
                            <div class="icon" style="background-color: rgba(255, 109, 40, 0.2); color: var(--primary);">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <h3>Đã góp tháng này</h3>
                            <p id="paid-count">0</p>
                            <div class="trend down">
                                <i class="fas fa-arrow-down"></i> 3 thành viên chưa góp
                            </div>
                        </div>
                        <div class="fund-card" style="background-color: rgba(245, 158, 11, 0.1);">
                            <div class="icon" style="background-color: rgba(245, 158, 11, 0.2); color: var(--warning);">
                                <i class="fas fa-clock"></i>
                            </div>
                            <h3>Chờ xử lý</h3>
                            <p id="pending-count">0</p>
                            <div class="trend up">
                                <i class="fas fa-arrow-up"></i> 2 yêu cầu mới
                            </div>
                        </div>
                    </div>
                </div>
    
                <!-- Contribution Management -->
                <div class="card">
                    <div class="section-title">
                        <h2>Quản Lý Góp Quỹ</h2>
                        <div class="section-actions">
                            <button class="btn" onclick="openAddMemberModal()">
                                <i class="fas fa-plus"></i> Thêm thành viên
                            </button>
                            <button class="btn btn-secondary" onclick="exportToExcel()">
                                <i class="fas fa-file-export"></i> Xuất Excel
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="contribution-table">
                            <thead>
                                <tr>
                                    <th>Thành viên</th>
                                    <th>Số tiền</th>
                                    <th>Chu kỳ</th>
                                    <th>Lần góp cuối</th>
                                    <th>Trạng thái</th>
                                    <th>Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="contribution-list"></tbody>
                        </table>
                    </div>
                    <!-- Add Member Form -->
                    <div class="fund-form">
                        <div class="form-group">
                            <label for="member-name">Tên thành viên</label>
                            <input type="text" id="member-name" class="form-control" placeholder="Nhập tên thành viên">
                        </div>
                        <div class="form-group">
                            <label for="contribution-amount">Số tiền (VNĐ)</label>
                            <input type="number" id="contribution-amount" class="form-control" placeholder="Nhập số tiền" min="0">
                        </div>
                        <div class="form-group">
                            <label for="contribution-period">Chu kỳ</label>
                            <select id="contribution-period" class="form-control">
                                <option value="weekly">Hàng tuần</option>
                                <option value="monthly" selected>Hàng tháng</option>
                                <option value="quarterly">Hàng quý</option>
                                <option value="yearly">Hàng năm</option>
                            </select>
                        </div>
                        <button class="btn" onclick="addMember()">
                            <i class="fas fa-plus"></i> Thêm thành viên
                        </button>
                    </div>
                </div>
    
                <!-- Recent Transactions -->
                <div class="card">
                    <div class="section-title">
                        <h2>Giao Dịch Gần Đây</h2>
                        <div class="section-actions">
                            <button class="btn" onclick="openTransactionModal()">
                                <i class="fas fa-plus"></i> Thêm giao dịch
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="contribution-table">
                            <thead>
                                <tr>
                                    <th>Ngày</th>
                                    <th>Mô tả</th>
                                    <th>Số tiền</th>
                                    <th>Người thực hiện</th>
                                    <th>Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="transaction-list"></tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    
        <!-- Add Member Modal -->
        <div class="modal" id="addMemberModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Thêm Thành Viên Mới</h3>
                    <button class="modal-close" onclick="closeModal('addMemberModal')">×</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="modal-member-id">Thành viên</label>
                        <select id="modal-member-id" class="form-control">
                            <option value="">Chọn thành viên</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modal-contribution-amount">Số tiền (VNĐ)</label>
                        <input type="number" id="modal-contribution-amount" class="form-control" placeholder="Nhập số tiền" min="0">
                    </div>
                    <div class="form-group">
                        <label for="modal-contribution-period">Chu kỳ</label>
                        <select id="modal-contribution-period" class="form-control">
                            <option value="weekly">Hàng tuần</option>
                            <option value="monthly" selected>Hàng tháng</option>
                            <option value="quarterly">Hàng quý</option>
                            <option value="yearly">Hàng năm</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modal-member-email">Email (tùy chọn)</label>
                        <input type="email" id="modal-member-email" class="form-control" placeholder="Nhập email">
                    </div>
                    <div class="form-group">
                        <label for="modal-member-phone">Số điện thoại (tùy chọn)</label>
                        <input type="tel" id="modal-member-phone" class="form-control" placeholder="Nhập số điện thoại">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn" onclick="addMemberFromModal()">
                        <i class="fas fa-save"></i> Lưu
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal('addMemberModal')">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                </div>
            </div>
        </div>
    
        <!-- Add Fund Modal -->
        <div class="modal" id="addFundModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Thêm Quỹ Mới</h3>
                    <button class="modal-close" onclick="closeModal('addFundModal')">×</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="fund-name">Tên quỹ</label>
                        <input type="text" id="fund-name" class="form-control" placeholder="Nhập tên quỹ">
                    </div>
                    <div class="form-group">
                        <label for="fund-amount">Số tiền (VNĐ)</label>
                        <input type="number" id="fund-amount" class="form-control" placeholder="Nhập số tiền" min="0">
                    </div>
                    <div class="form-group">
                        <label for="fund-description">Mô tả</label>
                        <textarea id="fund-description" class="form-control" placeholder="Nhập mô tả" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="fund-category">Danh mục</label>
                        <select id="fund-category" class="form-control">
                            <option value="general">Quỹ chung</option>
                            <option value="saving">Tiết kiệm</option>
                            <option value="event">Sự kiện</option>
                            <option value="emergency">Khẩn cấp</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn" onclick="addFund()">
                        <i class="fas fa-save"></i> Lưu
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal('addFundModal')">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                </div>
            </div>
        </div>
    
        <!-- Transaction Modal -->
        <div class="modal" id="transactionModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Thêm Giao Dịch Mới</h3>
                    <button class="modal-close" onclick="closeModal('transactionModal')">×</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="transaction-type">Loại giao dịch</label>
                        <select id="transaction-type" class="form-control">
                            <option value="income">Thu</option>
                            <option value="expense">Chi</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="transaction-amount">Số tiền (VNĐ)</label>
                        <input type="number" id="transaction-amount" class="form-control" placeholder="Nhập số tiền" min="0">
                    </div>
                    <div class="form-group">
                        <label for="transaction-date">Ngày</label>
                        <input type="date" id="transaction-date" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="transaction-description">Mô tả</label>
                        <input type="text" id="transaction-description" class="form-control" placeholder="Nhập mô tả">
                    </div>
                    <div class="form-group">
                        <label for="transaction-category">Danh mục</label>
                        <select id="transaction-category" class="form-control">
                            <option value="contribution">Đóng góp</option>
                            <option value="food">Ăn uống</option>
                            <option value="utility">Tiện ích</option>
                            <option value="event">Sự kiện</option>
                            <option value="other">Khác</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="transaction-member">Thành viên (tùy chọn)</label>
                        <select id="transaction-member" class="form-control">
                            <option value="">Chọn thành viên</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn" onclick="addTransaction()">
                        <i class="fas fa-save"></i> Lưu
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal('transactionModal')">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                </div>
            </div>
        </div>
    
        <script>
            // Configuration
            const API_BASE_URL = '/api';
            const GROUP_ID = 1; // Giả định group_id = 1, thay đổi theo thực tế
            const FUND_ID = 1;  // Giả định fund_id = 1, thay đổi theo thực tế
    
            // Helper function for API requests
            async function apiRequest(endpoint, method = 'GET', data = null) {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' }
                };
                if (data) {
                    options.body = JSON.stringify(data);
                }
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                return response.json();
            }
    
            // Render fund overview and contributions
            async function renderFund() {
                const contributionList = document.getElementById('contribution-list');
                contributionList.innerHTML = '';
    
                // Fetch contributions
                const contributions = await apiRequest(`/contributions/${FUND_ID}`);
                let paidCount = 0;
                let pendingCount = 0;
    
                // Calculate total balance
                const fund = await apiRequest(`/funds/${GROUP_ID}`);
                const totalBalance = fund.length > 0 ? fund[0].amount : 0;
    
                contributions.forEach((member, index) => {
                    if (member.paid) paidCount++;
                    else pendingCount++;
    
                    const lastPaidDate = member.last_paid ? new Date(member.last_paid) : null;
                    const formattedDate = lastPaidDate ? lastPaidDate.toLocaleDateString('vi-VN') : 'Chưa có';
    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div class="member-info">
                                <div class="member-avatar">${member.name.charAt(0)}</div>
                                <div>
                                    <div>${member.name}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-light)">${member.email || 'Không có email'}</div>
                                </div>
                            </div>
                        </td>
                        <td>${member.amount.toLocaleString('vi-VN')} VNĐ</td>
                        <td>${getPeriodText(member.period)}</td>
                        <td>${formattedDate}</td>
                        <td>
                            <span class="status ${member.paid ? 'paid' : getPaymentStatus(member)}">
                                ${member.paid ? 'Đã góp' : getPaymentStatusText(member)}
                            </span>
                        </td>
                        <td>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="action-btn confirm" onclick="confirmContribution(${member.id})" ${member.paid ? 'disabled' : ''}>
                                    <i class="fas fa-check"></i> Xác nhận
                                </button>
                                <button class="action-btn notify" onclick="sendReminder(${member.id})">
                                    <i class="fas fa-bell"></i> Nhắc nhở
                                </button>
                                <button class="action-btn edit" onclick="editMember(${member.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn delete" onclick="deleteMember(${member.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    contributionList.appendChild(row);
                });
    
                document.getElementById('fund-balance').textContent = `${totalBalance.toLocaleString('vi-VN')} VNĐ`;
                document.getElementById('member-count').textContent = contributions.length;
                document.getElementById('paid-count').textContent = paidCount;
                document.getElementById('pending-count').textContent = pendingCount;
            }
    
            // Render transactions
            async function renderTransactions() {
                const transactionList = document.getElementById('transaction-list');
                transactionList.innerHTML = '';
    
                const transactions = await apiRequest(`/transactions/${FUND_ID}`);
                transactions.forEach((transaction, index) => {
                    const transactionDate = new Date(transaction.date);
                    const formattedDate = transactionDate.toLocaleDateString('vi-VN');
                    const memberName = transaction.member_name || 'Nhóm';
    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formattedDate}</td>
                        <td>${transaction.description}</td>
                        <td style="color: ${transaction.type === 'income' ? 'var(--success)' : 'var(--danger)'}">
                            ${transaction.type === 'income' ? '+' : '-'}${transaction.amount.toLocaleString('vi-VN')} VNĐ
                        </td>
                        <td>${memberName}</td>
                        <td>
                            <button class="action-btn delete" onclick="deleteTransaction(${transaction.id})">
                                <i class="fas fa-trash"></i> Xóa
                            </button>
                        </td>
                    `;
                    transactionList.appendChild(row);
                });
            }
    
            // Update member dropdown for transactions
            async function updateMemberDropdown() {
                const dropdown = document.getElementById('transaction-member');
                const modalDropdown = document.getElementById('modal-member-id');
                dropdown.innerHTML = '<option value="">Chọn thành viên</option>';
                modalDropdown.innerHTML = '<option value="">Chọn thành viên</option>';
    
                const contributions = await apiRequest(`/contributions/${FUND_ID}`);
                contributions.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.member_id;
                    option.textContent = member.name;
                    dropdown.appendChild(option);
    
                    const modalOption = document.createElement('option');
                    modalOption.value = member.member_id;
                    modalOption.textContent = member.name;
                    modalDropdown.appendChild(modalOption);
                });
            }
    
            // Helper functions
            function getPeriodText(period) {
                const periods = {
                    'weekly': 'Hàng tuần',
                    'monthly': 'Hàng tháng',
                    'quarterly': 'Hàng quý',
                    'yearly': 'Hàng năm'
                };
                return periods[period] || period;
            }
    
            function getPaymentStatus(member) {
                if (member.paid) return 'paid';
                if (!member.last_paid) return 'pending';
    
                const lastPaidDate = new Date(member.last_paid);
                const now = new Date();
                let daysPassed = (now - lastPaidDate) / (1000 * 60 * 60 * 24);
    
                if (member.period === 'weekly') {
                    return daysPassed > 7 ? 'overdue' : 'pending';
                } else if (member.period === 'monthly') {
                    const monthsPassed = (now.getFullYear() - lastPaidDate.getFullYear()) * 12 +
                                        (now.getMonth() - lastPaidDate.getMonth());
                    return monthsPassed >= 1 ? 'overdue' : 'pending';
                } else if (member.period === 'quarterly') {
                    const monthsPassed = (now.getFullYear() - lastPaidDate.getFullYear()) * 12 +
                                        (now.getMonth() - lastPaidDate.getMonth());
                    return monthsPassed >= 3 ? 'overdue' : 'pending';
                } else if (member.period === 'yearly') {
                    const yearsPassed = now.getFullYear() - lastPaidDate.getFullYear();
                    return yearsPassed >= 1 ? 'overdue' : 'pending';
                }
                return 'pending';
            }
    
            function getPaymentStatusText(member) {
                const status = getPaymentStatus(member);
                return status === 'overdue' ? 'Quá hạn' : 'Chưa góp';
            }
    
            // Modal functions
            window.openAddMemberModal = function() {
                document.getElementById('addMemberModal').classList.add('active');
                document.getElementById('modal-member-id').focus();
            };
    
            window.closeModal = function(modalId) {
                document.getElementById(modalId).classList.remove('active');
                // Clear modal fields
                if (modalId === 'addMemberModal') {
                    document.getElementById('modal-member-id').value = '';
                    document.getElementById('modal-contribution-amount').value = '';
                    document.getElementById('modal-contribution-period').value = 'monthly';
                    document.getElementById('modal-member-email').value = '';
                    document.getElementById('modal-member-phone').value = '';
                    delete document.getElementById('addMemberModal').dataset.editingId;
                } else if (modalId === 'addFundModal') {
                    document.getElementById('fund-name').value = '';
                    document.getElementById('fund-amount').value = '';
                    document.getElementById('fund-description').value = '';
                    document.getElementById('fund-category').value = 'general';
                } else if (modalId === 'transactionModal') {
                    document.getElementById('transaction-type').value = 'income';
                    document.getElementById('transaction-amount').value = '';
                    document.getElementById('transaction-date').value = new Date().toISOString().split('T')[0];
                    document.getElementById('transaction-description').value = '';
                    document.getElementById('transaction-category').value = 'contribution';
                    document.getElementById('transaction-member').value = '';
                }
            };
    
            window.openAddFundModal = function() {
                document.getElementById('addFundModal').classList.add('active');
                document.getElementById('fund-name').focus();
            };
    
            window.openTransactionModal = function() {
                document.getElementById('transactionModal').classList.add('active');
                document.getElementById('transaction-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('transaction-amount').focus();
            };
    
            // Member functions
            window.addMemberFromModal = async function() {
                const memberId = document.getElementById('modal-member-id').value;
                const amount = parseInt(document.getElementById('modal-contribution-amount').value) || 0;
                const period = document.getElementById('modal-contribution-period').value;
                const email = document.getElementById('modal-member-email').value.trim();
                const phone = document.getElementById('modal-member-phone').value.trim();
    
                if (!memberId || amount <= 0) {
                    alert('Vui lòng chọn thành viên và nhập số tiền hợp lệ!');
                    return;
                }
    
                const editingId = document.getElementById('addMemberModal').dataset.editingId;
                if (editingId) {
                    // Update existing contribution
                    await apiRequest(`/contributions/${editingId}`, 'PUT', {
                        amount,
                        period,
                        email: email || null,
                        phone: phone || null,
                        paid: false
                    });
                    delete document.getElementById('addMemberModal').dataset.editingId;
                } else {
                    // Add new contribution
                    await apiRequest('/contributions', 'POST', {
                        member_id: parseInt(memberId),
                        fund_id: FUND_ID,
                        amount,
                        period,
                        email: email || null,
                        phone: phone || null
                    });
                }
    
                closeModal('addMemberModal');
                await renderFund();
                await updateMemberDropdown();
            };
    
            window.addMember = async function() {
                const memberId = document.getElementById('member-name').value; // Giả định đây là member_id
                const amount = parseInt(document.getElementById('contribution-amount').value) || 0;
                const period = document.getElementById('contribution-period').value;
    
                if (!memberId || amount <= 0) {
                    alert('Vui lòng chọn thành viên và nhập số tiền hợp lệ!');
                    return;
                }
    
                await apiRequest('/contributions', 'POST', {
                    member_id: parseInt(memberId),
                    fund_id: FUND_ID,
                    amount,
                    period
                });
    
                document.getElementById('member-name').value = '';
                document.getElementById('contribution-amount').value = '';
    
                await renderFund();
                await updateMemberDropdown();
            };
    
            window.editMember = async function(contributionId) {
                const contributions = await apiRequest(`/contributions/${FUND_ID}`);
                const member = contributions.find(c => c.id === contributionId);
                if (!member) return;
    
                document.getElementById('modal-member-id').value = member.member_id;
                document.getElementById('modal-contribution-amount').value = member.amount;
                document.getElementById('modal-contribution-period').value = member.period;
                document.getElementById('modal-member-email').value = member.email || '';
                document.getElementById('modal-member-phone').value = member.phone || '';
                document.getElementById('addMemberModal').dataset.editingId = contributionId;
    
                document.getElementById('addMemberModal').classList.add('active');
            };
    
            window.deleteMember = async function(contributionId) {
                if (confirm('Bạn có chắc chắn muốn xóa đóng góp này?')) {
                    await apiRequest(`/contributions/${contributionId}`, 'DELETE');
                    await renderFund();
                    await updateMemberDropdown();
                }
            };
    
            window.confirmContribution = async function(contributionId) {
                const contributions = await apiRequest(`/contributions/${FUND_ID}`);
                const member = contributions.find(c => c.id === contributionId);
                if (!member) return;
    
                const today = new Date().toISOString().split('T')[0];
                await apiRequest(`/contributions/${contributionId}/confirm`, 'PUT', { last_paid: today });
    
                // Add transaction
                await apiRequest('/transactions', 'POST', {
                    fund_id: FUND_ID,
                    member_id: member.member_id,
                    type: 'income',
                    amount: member.amount,
                    date: today,
                    description: `Đóng góp ${getPeriodText(member.period)} từ ${member.name}`,
                    category: 'contribution'
                });
    
                await renderFund();
                await renderTransactions();
            };
    
            window.sendReminder = async function(contributionId) {
                const contributions = await apiRequest(`/contributions/${FUND_ID}`);
                const member = contributions.find(c => c.id === contributionId);
                if (!member) return;
    
                const status = getPaymentStatus(member);
                const message = status === 'overdue'
                    ? `NHẮC NHỞ: ${member.name} chưa đóng góp ${getPeriodText(member.period)}. Số tiền: ${member.amount.toLocaleString('vi-VN')} VNĐ (QUÁ HẠN)`
                    : `Nhắc nhở: ${member.name} vui lòng đóng góp ${getPeriodText(member.period)}. Số tiền: ${member.amount.toLocaleString('vi-VN')} VNĐ`;
    
                await apiRequest('/notifications', 'POST', {
                    group_id: GROUP_ID,
                    member_id: member.member_id,
                    title: 'Nhắc nhở đóng góp quỹ',
                    message
                });
    
                alert(message);
                await updateNotificationCount();
            };
    
            // Fund functions
            window.addFund = async function() {
                const name = document.getElementById('fund-name').value.trim();
                const amount = parseInt(document.getElementById('fund-amount').value) || 0;
                const description = document.getElementById('fund-description').value.trim();
                const category = document.getElementById('fund-category').value;
    
                if (!name || amount <= 0) {
                    alert('Vui lòng nhập tên quỹ và số tiền hợp lệ!');
                    return;
                }
    
                await apiRequest('/funds', 'POST', {
                    group_id: GROUP_ID,
                    name,
                    amount,
                    description,
                    category
                });
    
                closeModal('addFundModal');
                await renderFund();
            };
    
            // Transaction functions
            window.addTransaction = async function() {
                const type = document.getElementById('transaction-type').value;
                const amount = parseInt(document.getElementById('transaction-amount').value) || 0;
                const date = document.getElementById('transaction-date').value;
                const description = document.getElementById('transaction-description').value.trim();
                const category = document.getElementById('transaction-category').value;
                const memberId = document.getElementById('transaction-member').value || null;
    
                if (!date || amount <= 0 || !description) {
                    alert('Vui lòng nhập đầy đủ thông tin giao dịch!');
                    return;
                }
    
                await apiRequest('/transactions', 'POST', {
                    fund_id: FUND_ID,
                    member_id: memberId ? parseInt(memberId) : null,
                    type,
                    amount,
                    date,
                    description,
                    category
                });
    
                closeModal('transactionModal');
                await renderFund();
                await renderTransactions();
            };
    
            window.deleteTransaction = async function(transactionId) {
                if (confirm('Bạn có chắc chắn muốn xóa giao dịch này?')) {
                    await apiRequest(`/transactions/${transactionId}`, 'DELETE');
                    await renderFund();
                    await renderTransactions();
                }
            };
    
            // Notification functions
            async function updateNotificationCount() {
                const notifications = await apiRequest(`/notifications/${GROUP_ID}`);
                const unreadCount = notifications.filter(n => !n.is_read).length;
                document.getElementById('notification-count').textContent = unreadCount;
            }
    
            // Export function (Placeholder)
            window.exportToExcel = function() {
                alert('Chức năng xuất Excel sẽ được thực hiện ở phiên bản sau!');
            };
    
            // Check for overdue contributions
            async function checkOverdueContributions() {
                const contributions = await apiRequest(`/contributions/${FUND_ID}`);
                let hasOverdue = false;
    
                contributions.forEach(member => {
                    if (!member.paid && member.last_paid) {
                        const lastPaidDate = new Date(member.last_paid);
                        const now = new Date();
                        let isOverdue = false;
    
                        if (member.period === 'weekly') {
                            const diffDays = (now - lastPaidDate) / (1000 * 60 * 60 * 24);
                            isOverdue = diffDays > 7;
                        } else if (member.period === 'monthly') {
                            isOverdue = now.getMonth() !== lastPaidDate.getMonth() ||
                                        now.getFullYear() !== lastPaidDate.getFullYear();
                        } else if (member.period === 'quarterly') {
                            const monthsPassed = (now.getFullYear() - lastPaidDate.getFullYear()) * 12 +
                                                (now.getMonth() - lastPaidDate.getMonth());
                            isOverdue = monthsPassed >= 3;
                        } else if (member.period === 'yearly') {
    isOverdue = now.getFullYear() !== lastPaidDate.getFullYear();
}

    
                        if (isOverdue) {
                            hasOverdue = true;
                        }
                    }
                });
    
                if (hasOverdue) {
                    await renderFund();
                }
            }
    
            // Initialize
            document.addEventListener('DOMContentLoaded', async () => {
                await renderFund();
                await renderTransactions();
                await updateMemberDropdown();
                await updateNotificationCount();
                checkOverdueContributions();
                setInterval(checkOverdueContributions, 24 * 60 * 60 * 1000);
            });
        </script>
    
<!-- js chung -->
<script src="../static/js/app.js"></script>
</body>
</html>